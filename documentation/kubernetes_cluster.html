<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kubernetes Cluster Configuration</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="header">
        <h1>The Kubernetes Cluster</h1>
        <p>Transforming bare-metal nodes into a production-ready cluster.</p>
    </div>

    <div class="nav">
        <a href="index.html">Home</a>
        <a href="provisioning_server.html">Provisioning Server</a>
        <a href="kubernetes_cluster.html">Kubernetes Cluster</a>
        <a href="end_to_end_workflow.html">End-to-End Workflow</a>
    </div>

    <div class="container">
        <div class="content">
            <h2>Ansible Configuration</h2>
            <p>Once a server has been automatically provisioned with a base Ubuntu OS, the <a href="https://github.com/sddcinfo/ansible-kubernetes-nodes" target="_blank">ansible-kubernetes-nodes</a> project takes over. This collection of Ansible roles performs all the necessary steps to configure the node and have it join the Kubernetes cluster.</p>

            <h3>Key Configuration File</h3>
            <p>The most critical file for customization is <a href="https://github.com/sddcinfo/ansible-kubernetes-nodes/blob/main/group_vars/all.yml" target="_blank"><code>group_vars/all.yml</code></a>. This is where you define the global settings for your cluster, including:</p>
            <ul>
                <li><code>k8s_version</code>: The specific version of Kubernetes to deploy.</li>
                <li><code>pod_network_cidr</code>: The IP address range to be used for the pod network (e.g., Calico).</li>
                <li><code>ceph_devices</code>: A comma-separated list of the block devices that will be used for Ceph storage. <strong>This must be updated for your environment.</strong></li>
            </ul>

            <h3>Role Breakdown</h3>
            <p>The main <a href="https://github.com/sddcinfo/ansible-kubernetes-nodes/blob/main/site.yml" target="_blank"><code>site.yml</code></a> playbook executes the following roles in order:</p>

            <h4>1. <code>ceph_prereqs</code></h4>
            <p>This role prepares the node for integration with a Ceph storage cluster by installing the necessary client packages (<code>ceph-common</code>) and configuring a dedicated network interface for storage traffic.</p>

            <h4>2. <code>common</code></h4>
            <p>This is a foundational role that runs on all nodes. It handles tasks that are common to both controllers and workers:</p>
            <ul>
                <li><strong>System Configuration:</strong> Disables IPv6 and configures essential kernel parameters for container networking via <code>sysctl</code>.</li>
                <li><strong>Container Runtime:</strong> Installs and configures <code>containerd</code>, ensuring the <code>SystemdCgroup</code> is enabled for compatibility with the kubelet.</li>
                <li><strong>Kubernetes Packages:</strong> Adds the official Kubernetes APT repository and GPG key, then installs the core components: <code>kubelet</code>, <code>kubeadm</code>, and <code>kubectl</code> at the version specified in your variables.</li>
                <li><strong>Package Pinning:</strong> Places a "hold" on the Kubernetes packages to prevent accidental, unmanaged upgrades.</li>
            </ul>

            <h4>3. <code>controller</code></h4>
            <p>This role runs only on the node(s) designated as the control plane in the <a href="https://github.com/sddcinfo/ansible-kubernetes-nodes/blob/main/inventory.ini" target="_blank">inventory</a>. It performs the following critical actions:</p>
            <ul>
                <li><strong>Cluster Initialization:</strong> Runs <code>kubeadm init</code> to bootstrap the Kubernetes cluster. This is an idempotent operation; it checks if a cluster is already initialized and skips if so.</li>
                <li><strong>Kubeconfig:</strong> Copies the <code>admin.conf</code> file to the user's home directory, allowing you to immediately interact with the cluster using <code>kubectl</code>.</li>
                <li><strong>CNI Installation:</strong> Applies the manifest for the Calico network plugin, enabling pod-to-pod communication.</li>
                <li><strong>Join Token Generation:</strong> Creates a new join token and stores it for the worker nodes to use.</li>
            </ul>

            <h4>4. <code>workers</code></h4>
            <p>This role runs on all worker nodes. Its primary responsibility is to securely join the node to the cluster using the token generated by the controller.</p>
        </div>
    </div>

    <div class="footer">
        <p>Documentation generated for the sddc.info infrastructure.</p>
    </div>
</body>
</html>
