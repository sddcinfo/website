<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ansible Infrastructure Documentation</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 960px;
            margin: auto;
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        h1, h2, h3 {
            color: #2c3e50;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            margin-top: 30px;
        }
        h1 {
            font-size: 2.5em;
            text-align: center;
            border-bottom: 3px solid #3498db;
        }
        code {
            background-color: #ecf0f1;
            padding: 2px 5px;
            border-radius: 4px;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
        }
        pre {
            background-color: #2c3e50;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        pre code {
            background-color: transparent;
            padding: 0;
            border-radius: 0;
        }
        strong {
            color: #c0392b;
        }
        ul, ol {
            padding-left: 20px;
        }
        li {
            margin-bottom: 10px;
        }
        hr {
            border: 0;
            height: 1px;
            background: #ddd;
            margin: 40px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Ansible Infrastructure Automation Ecosystem</h1>

        <h2>1. Overview</h2>
        <p>This document outlines a complete infrastructure automation ecosystem designed to provision and configure a Kubernetes cluster from bare metal. The system is orchestrated by two primary Ansible projects:</p>
        <ol>
            <li><strong><code>ansible_provisioning_server</code></strong>: Configures a dedicated server to handle all the necessary network services for automated OS installation (DHCP, TFTP, HTTP). It also acts as a NAT gateway for the cluster nodes.</li>
            <li><strong><code>node1-ansible</code></strong>: Configures the newly provisioned bare-metal nodes into a fully functional Kubernetes cluster, complete with storage prerequisites for Ceph.</li>
        </ol>
        <p>The entire process is designed to be idempotent and centrally managed, minimizing manual intervention and ensuring consistency.</p>

        <hr>

        <h2>2. System Architecture</h2>
        <p>The architecture follows a standard client-server model for provisioning.</p>

        <h3>2.1. The Provisioning Server</h3>
        <p>This server is the heart of the ecosystem. Its responsibilities include:</p>
        <ul>
            <li><strong>DHCP Server (dnsmasq)</strong>: Assigns IP addresses to new nodes based on their MAC addresses and directs them to the TFTP server.</li>
            <li><strong>TFTP Server (tftpd-hpa)</strong>: Serves the iPXE bootloader to nodes, which is the first step in the boot process.</li>
            <li><strong>HTTP Server (Nginx & PHP)</strong>:
                <ul>
                    <li>Serves the iPXE boot script (<code>index.php</code>) which provides kernel and initrd files for booting the Ubuntu installer.</li>
                    <li>Hosts the Ubuntu installation files (extracted from the ISO).</li>
                    <li>Provides the cloud-init autoinstall configuration files (<code>user-data</code>, <code>meta-data</code>) for unattended OS installation.</li>
                    <li>Displays a real-time <strong>Provisioning Status Page</strong> when accessed from a web browser.</li>
                </ul>
            </li>
            <li><strong>NAT Gateway (iptables)</strong>: Provides internet access to the cluster nodes by performing Network Address Translation (NAT) for traffic from the internal network (<code>10.10.1.0/24</code>) out to the internet via the <code>ens34</code> interface.</li>
        </ul>

        <h3>2.2. The Kubernetes Nodes</h3>
        <p>These are the bare-metal machines that will form the cluster. Their lifecycle is as follows:</p>
        <ol>
            <li><strong>PXE Boot</strong>: On power-on, the node performs a network boot.</li>
            <li><strong>DHCP & TFTP</strong>: The provisioning server assigns an IP and serves the iPXE bootloader.</li>
            <li><strong>iPXE Script</strong>: The node fetches and executes the iPXE script from the HTTP server.</li>
            <li><strong>Autoinstall</strong>: The script instructs the node to boot the Ubuntu installer with cloud-init autoinstall parameters. The node fetches its specific configuration and installs the OS without any manual input.</li>
            <li><strong>Ansible Configuration</strong>: Once the OS is installed, the <code>node1-ansible</code> project takes over to configure the node as either a Kubernetes controller or worker.</li>
        </ol>

        <hr>

        <h2>3. Directory Structure</h2>

        <h3>3.1. <code>/home/sysadmin/ansible_provisioning_server/</code></h3>
        <pre><code>.
├── ansible.cfg
├── inventory
├── roles/
│   ├── common/         # Common tasks for the server (packages, sysctl, netplan, NAT)
│   ├── iso_preparation/  # Downloads and extracts the Ubuntu ISO
│   ├── netboot/        # Configures DHCP (dnsmasq) and TFTP
│   └── web/            # Configures Nginx, PHP, and generates autoinstall configs
└── site.yml            # The main playbook to run everything
</code></pre>

        <h3>3.2. <code>/home/sysadmin/node1-ansible/</code></h3>
        <pre><code>.
├── ansible.cfg
├── group_vars/
│   └── all.yml         # CRITICAL: Global variables (k8s version, Ceph devices)
├── inventory.ini       # Defines controller and worker nodes
├── roles/
│   ├── ceph_prereqs/   # Installs Ceph dependencies
│   ├── common/         # Common tasks for all k8s nodes (containerd, kube packages)
│   ├── controller/     # Initializes the Kubernetes controller
│   └── workers/        # Joins worker nodes to the cluster
├── site.yml            # The main playbook to configure the entire cluster
├── fix_kernel_modules.yml # Maintenance playbook
└── update_nodes.yml       # Maintenance playbook
</code></pre>

        <hr>

        <h2>4. Configuration</h2>

        <h3>4.1. Provisioning Server (<code>ansible_provisioning_server</code>)</h3>
        <ul>
            <li><strong>Node Network Details</strong>: The single source of truth for all node MAC addresses, IPs, and hostnames is in <code>roles/netboot/vars/main.yml</code>. Edit the <code>provisioning_nodes</code> and <code>console_nodes</code> lists to match your hardware.</li>
            <li><strong>Server Network</strong>: The static IP (<code>10.10.1.1/24</code>) and DHCP (<code>ens34</code>) configuration for the provisioning server itself is managed in <code>roles/common/templates/01-netcfg.yaml.j2</code>.</li>
        </ul>

        <h3>4.2. Kubernetes Nodes (<code>node1-ansible</code>)</h3>
        <ul>
            <li><strong>Inventory</strong>: Define which nodes are controllers and which are workers in <code>inventory.ini</code>.</li>
            <li><strong>Global Variables</strong>: <strong>This is the most important file to edit.</strong> Open <code>group_vars/all.yml</code> to configure:
                <ul>
                    <li><code>k8s_version</code>: The version of Kubernetes to install (e.g., <code>1.33</code>).</li>
                    <li><code>pod_network_cidr</code>: The CIDR for the pod network.</li>
                    <li><code>ceph_devices</code>: <strong>You must update this</strong> with the comma-separated list of block devices to be used for Ceph on your nodes (e.g., <code>"/dev/sdb,/dev/sdc"</code>).</li>
                </ul>
            </li>
        </ul>

        <hr>

        <h2>5. Execution Workflow</h2>

        <h3>Step 1: Configure the Provisioning Server</h3>
        <p>Run the main playbook for the provisioning server. This only needs to be done once, or when you change the server's configuration.</p>
        <pre><code># Navigate to the provisioning server's Ansible directory
cd /home/sysadmin/ansible_provisioning_server

# Run the main playbook
ansible-playbook -i inventory site.yml</code></pre>

        <h3>Step 2: Provision the Operating System</h3>
        <p>Power on your bare-metal machines. They will automatically PXE boot and install Ubuntu.</p>
        <p>You can monitor the progress by browsing to the provisioning server's IP address:</p>
        <p><strong><code>http://10.10.1.1</code></strong></p>
        <p>This will show the live status page, indicating which nodes are new, installing, or done.</p>

        <h3>Step 3: Configure the Kubernetes Cluster</h3>
        <p>Once the nodes are listed as <code>DONE</code> on the status page, you can configure them as a Kubernetes cluster.</p>
        <pre><code># Navigate to the Kubernetes nodes' Ansible directory
cd /home/sysadmin/node1-ansible

# Run the main playbook to set up the entire cluster
ansible-playbook -i inventory.ini site.yml</code></pre>

        <hr>

        <h2>6. Maintenance</h2>
        <p>The following playbooks are for ongoing maintenance and can be run as needed.</p>
        <ul>
            <li><strong>Update All Nodes</strong>: To safely update packages and reboot all Kubernetes nodes one at a time.
                <pre><code>cd /home/sysadmin/node1-ansible
ansible-playbook -i inventory.ini update_nodes.yml</code></pre>
            </li>
            <li><strong>Fix Kernel Modules</strong>: To force a reinstall of kernel modules if you encounter issues.
                <pre><code>cd /home/sysadmin/node1-ansible
ansible-playbook -i inventory.ini fix_kernel_modules.yml</code></pre>
            </li>
        </ul>
    </div>
</body>
</html>
